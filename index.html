<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×©×¢×•×ª ×•×©×›×¨ - ××ª×Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --secondary: #3498db; --bg-color: #f4f6f8;
            --row-weekend: #ffebee; --row-event: #fff3e0; --approved-bg: #e8f5e9; --missing-bg: #fff9c4;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; }

        /* --- ××¡×š ×¨×’×™×œ --- */
        #app-container { max-width: 100%; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.6rem; }
        
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .toolbar-group { display: flex; gap: 5px; align-items: center; padding-left: 10px; border-left: 1px solid #eee; }
        .toolbar-group:last-child { border-left: none; }
        
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; color: white; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--secondary); } .btn-success { background-color: #27ae60; } .btn-danger { background-color: #e74c3c; } .btn-warning { background-color: #f39c12; } .btn-info { background-color: #17a2b8; } .btn-whatsapp { background-color: #25D366; }
        select, input[type="file"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; }

        /* ×˜×‘×œ×” ×‘××¡×š */
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 1200px; }
        th { background-color: var(--primary); color: white; padding: 12px 6px; text-align: center; position: sticky; top: 0; z-index: 10; }
        td { padding: 6px 4px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        td input[type="time"] { width: 80px; text-align: center; background: #fafafa; border: 1px solid #ccc; border-radius: 3px; }
        td input[type="text"] { width: 100%; min-width: 100px; border: 1px solid #ccc; border-radius: 3px; }
        
        tr.row-weekend { background-color: var(--row-weekend); } tr.row-approved { background-color: var(--approved-bg) !important; } tr.row-missing { background-color: var(--missing-bg); }

        .summary-section { display: flex; gap: 15px; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 12px; flex-wrap: wrap; }
        .summary-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); flex: 1; min-width: 140px; text-align: center; border-bottom: 4px solid var(--secondary); }
        .summary-card .value { font-size: 1.6rem; font-weight: bold; color: var(--primary); }

        .bottom-report { margin-top: 30px; border: 1px solid #ddd; border-radius: 12px; padding: 20px; background: white; }
        .custom-text-area { width: 100%; height: 120px; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Segoe UI', sans-serif; font-size: 1rem; resize: vertical; }
        
        .diff-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .diff-table th { background: #e74c3c; color: white; padding: 8px; font-size: 0.9rem; }
        .diff-table td { border: 1px solid #eee; padding: 8px; text-align: center; }

        #message-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; display: none; z-index: 2000; }
        .msg-success { background: #27ae60; } .msg-error { background: #c0392b; }
        .checkbox-wrapper { display: flex; justify-content: center; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--secondary); }
        .filters-label { font-weight: bold; margin-left: 5px; font-size: 0.9rem; color: #555; }

        /* --- ×”×’×“×¨×•×ª ×”×“×¤×¡×” V14 --- */
        #print-area { display: none; }

        @media print {
            @page { size: landscape; margin: 5mm; }
            body, html { margin: 0; padding: 0; background: white; width: 100%; zoom: 95%; /* ×”×§×˜× ×” ××™× ×™××œ×™×ª ×‘×œ×‘×“ */ }
            #app-container, #message-area { display: none !important; }
            #print-area { display: block !important; width: 100%; position: absolute; left: 0; top: 0; }

            .print-page-1 { width: 100%; page-break-after: always; position: relative; }
            .print-page-2 { width: 100%; page-break-before: always; }

            .print-header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 10px; }
            
            /* ×˜×‘×œ×” ×œ×”×“×¤×¡×” */
            .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; table-layout: fixed; } /* ×¤×•× ×˜ ×§×¨×™× */
            
            /* ×¨×•×—×‘ ×¢××•×“×•×ª ×××•×–×Ÿ ×œ×§×¨×™××•×ª */
            .col-date { width: 7%; }
            .col-day { width: 5%; }
            .col-event { width: 10%; }
            .col-time { width: 8%; }
            .col-hours { width: 6%; }
            .col-diff { width: 7%; }
            .col-notes { width: 15%; }
            .col-status { width: 5%; }

            .print-table th { background-color: #f0f0f0 !important; color: black !important; border: 1px solid #333; padding: 4px; font-weight: bold; }
            .print-table td { border: 1px solid #999; padding: 3px; text-align: center; height: 20px; overflow: hidden; white-space: nowrap; }
            
            .print-summary-grid { display: flex; gap: 10px; margin-bottom: 20px; justify-content: space-between; border: 1px solid #ccc; padding: 10px; }
            .print-summary-box { border: 1px solid #000; padding: 10px; flex: 1; text-align: center; background: #fff !important; }
            .print-summary-box span { font-size: 14pt; font-weight: bold; }
            
            .print-letter { font-family: 'Arial', sans-serif; font-size: 12pt; line-height: 1.4; white-space: pre-wrap; margin-bottom: 20px; }
            
            .p-row-approved { background-color: #f0fff0 !important; -webkit-print-color-adjust: exact; }
            .p-row-weekend { background-color: #fff0f0 !important; -webkit-print-color-adjust: exact; }
            .p-diff { color: black; font-weight: bold; } /* ×©×—×•×¨ ××•×“×’×© ×œ×§×¨×™××•×ª */
            
            /* ×¢×™×¦×•×‘ ×”×•×™ */
            .status-ok { color: green; font-weight: bold; font-size: 1.2em; }
        }
    </style>
</head>
<body>

<div id="message-area"></div>

<div id="app-container">
    <header>
        <h1>ğŸ—“ï¸ ××¢×¨×›×ª ×©×¢×•×ª ×•×©×›×¨ - ××ª×Ÿ</h1>
        <div style="display:flex; gap:10px;">
            <select id="monthSelect" onchange="handleDateChange()"></select>
            <select id="yearSelect" onchange="handleDateChange()"></select>
        </div>
    </header>

    <div class="toolbar">
        <div class="toolbar-group">
            <input type="file" id="excelFile" accept=".xlsx" style="display:none" onchange="handleFile(this)">
            <button class="btn-success" onclick="document.getElementById('excelFile').click()">ğŸ“‚ ×˜×¢×Ÿ ×¤×™×œ</button>
            <button class="btn-warning" onclick="autoFillMatan()">ğŸ¤– ××œ× ××•×˜×•××˜×™</button>
            <button class="btn-danger" onclick="clearData()">ğŸ—‘ï¸ × ×§×”</button>
        </div>
        <div class="toolbar-group">
            <button class="btn-info" onclick="saveBackup()">ğŸ’¾ ×’×™×‘×•×™</button>
            <input type="file" id="backupFile" accept=".json" style="display:none" onchange="loadBackup(this)">
            <button class="btn-info" onclick="document.getElementById('backupFile').click()">ğŸ“¥ ×˜×¢×Ÿ ×’×™×‘×•×™</button>
        </div>
        <div class="toolbar-group">
            <button class="btn-primary" onclick="generatePrintView()">ğŸ–¨ï¸ ×”×“×¤×¡ / PDF</button>
            <button class="btn-whatsapp" onclick="sendWhatsapp()">ğŸ“± ×•×•××˜×¡××¤</button>
            <button class="btn-primary" onclick="exportToExcel()">ğŸ“Š Excel</button>
        </div>
        <div class="toolbar-group" style="margin-right: auto;">
            <label class="filters-label"><input type="checkbox" id="toggleWeekend" checked onchange="renderTable()"> ×¡×•×¤"×©</label>
            <label class="filters-label"><input type="checkbox" id="toggleVacation" checked onchange="renderTable()"> ×—×•×¤×©×™×</label>
            <label class="filters-label"><input type="checkbox" id="toggleTravel" checked onchange="renderTable()"> × ×¡×™×¢×•×ª</label>
        </div>
    </div>

    <div class="table-responsive">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="5%">×ª××¨×™×š</th> <th width="5%">×™×•×</th> <th width="8%">××™×¨×•×¢</th> <th width="4%">× ×¡×™×¢×”</th>
                    <th style="background:#546e7a">×›× ×™×¡×” (×¤×™×œ)</th> <th style="background:#546e7a">×™×¦×™××” (×¤×™×œ)</th> <th style="background:#546e7a">×¡×”"×›</th>
                    <th style="background:#2980b9">×›× ×™×¡×” (××ª×Ÿ)</th> <th style="background:#2980b9">×™×¦×™××” (××ª×Ÿ)</th> <th style="background:#2980b9">×¡×”"×›</th>
                    <th width="5%">××™×—×•×¨</th> <th width="5%">×”×¤×¨×©</th> <th>×”×¢×¨×•×ª</th> <th width="5%">×××•×©×¨</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="summary-section">
        <div class="summary-card"><h3>×©×¢×•×ª ×¤×™×œ</h3><div id="sumPhil" class="value">0.00</div></div>
        <div class="summary-card"><h3>×©×¢×•×ª ××ª×Ÿ</h3><div id="sumMatan" class="value">0.00</div></div>
        <div class="summary-card"><h3>×”×¤×¨×©</h3><div id="sumDiff" class="value">0.00</div></div>
        <div class="summary-card" style="border-color:#e74c3c"><h3>××™×—×•×¨×™× (×“×§')</h3><div id="sumLate" class="value" style="color:#e74c3c">0</div></div>
        <div class="summary-card" style="border-color:#27ae60; background:#f0fff4">
            <h3>×œ×ª×©×œ×•×</h3>
            <div id="sumSalary" class="value" style="color:#27ae60">â‚ª0</div>
            <div id="travelBreakdown" class="travel-detail">×›×•×œ×œ × ×¡×™×¢×•×ª: â‚ª0</div>
        </div>
    </div>

    <div class="bottom-report">
        <h2 style="margin:0 0 10px 0; color:var(--primary);">ğŸ“ ×¢×¨×™×›×ª ××›×ª×‘ × ×œ×•×•×” (×œ×“×£ 2)</h2>
        <textarea id="customEmailText" class="custom-text-area" oninput="saveData()"></textarea>

        <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“‹ ×¤×™×¨×•×˜ ×©×•×¨×•×ª ×œ×˜×™×¤×•×œ:</h3>
        <div id="screenNoDiffs" style="color:#27ae60; font-weight:bold; display:none; padding:10px;">âœ¨ ××™×Ÿ ×¤×¢×¨×™×! ×”×˜×‘×œ×” ×ª×”×™×” ×¨×™×§×” ×‘×“×•×—.</div>
        <table class="diff-table" id="screenDiffTable">
            <thead>
                <tr>
                    <th>×ª××¨×™×š</th> <th>×©×¢×•×ª ×¤×™×œ</th> <th>×©×¢×•×ª ××ª×Ÿ</th> <th>×”×¤×¨×©</th> <th>×”×¢×¨×•×ª</th>
                </tr>
            </thead>
            <tbody id="screenDiffBody"></tbody>
        </table>
    </div>
</div>

<div id="print-area">
    <div class="print-page-1">
        <div class="print-header">
            <h1>×“×•×— ×©×¢×•×ª ××¤×•×¨×˜ - <span id="pDate1"></span></h1>
        </div>
        <table class="print-table" id="printTableBody">
            <thead>
                <tr>
                    <th class="col-date">×ª××¨×™×š</th> 
                    <th class="col-day">×™×•×</th> 
                    <th class="col-event">××™×¨×•×¢</th>
                    <th class="col-time">×›× ×™×¡×” (×¤)</th> 
                    <th class="col-time">×™×¦×™××” (×¤)</th> 
                    <th class="col-hours">×©×¢×•×ª (×¤)</th>
                    <th class="col-time" style="font-weight:bold; border-right:2px solid #333">×›× ×™×¡×” (×)</th> 
                    <th class="col-time" style="font-weight:bold">×™×¦×™××” (×)</th> 
                    <th class="col-hours" style="font-weight:bold">×©×¢×•×ª (×)</th>
                    <th class="col-diff">×”×¤×¨×©</th> 
                    <th class="col-notes">×”×¢×¨×•×ª</th>
                    <th class="col-status">××™×©×•×¨</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="print-page-2">
        <div class="print-header">
            <h1>×¡×™×›×•× ×©×¢×•×ª ×•×©×›×¨ - <span id="pDate2"></span></h1>
        </div>

        <div class="print-summary-grid">
            <div class="print-summary-box"><h3>×¡×”"×› ×©×¢×•×ª ××ª×Ÿ</h3><span id="p2SumMatan"></span></div>
            <div class="print-summary-box"><h3>×¡×”"×› ×©×¢×•×ª ×¤×™×œ</h3><span id="p2SumPhil"></span></div>
            <div class="print-summary-box"><h3>×”×¤×¨×© ×©×¢×•×ª</h3><span id="p2SumDiff"></span></div>
            <div class="print-summary-box" style="border:2px solid black">
                <h3>×¡×”"×› ×œ×ª×©×œ×•×</h3><span id="p2SumPay"></span>
                <div id="p2Travel" style="font-size:10pt; margin-top:5px;"></div>
            </div>
        </div>

        <div class="print-letter">
            <strong>× ×•×©×: ×“×•×— ×©×¢×•×ª <span id="pDateLetter"></span> - ××ª×Ÿ</strong><br><br>
            <div id="printLetterContent"></div>
        </div>

        <h3>×¤×™×¨×•×˜ ×©×•×¨×•×ª ×¢× ×¤×¢×¨×™× / ×“×•×¨×©×•×ª ×”×ª×™×™×—×¡×•×ª:</h3>
        <table class="print-table" style="width:100%;">
            <thead>
                <tr>
                    <th style="width:15%">×ª××¨×™×š</th> <th>×©×¢×•×ª ×¤×™×œ</th> <th>×©×¢×•×ª ××ª×Ÿ</th> <th>×”×¤×¨×©</th> <th>×”×¢×¨×ª ××ª×Ÿ</th>
                </tr>
            </thead>
            <tbody id="diffTableBody"></tbody>
        </table>
        <div id="noDiffMsg" style="display:none; text-align:center; font-weight:bold; margin-top:10px;">
            * ××™×Ÿ ×¤×¢×¨×™× ××”×•×ª×™×™× ×”×—×•×“×©. ×›×œ ×”×©×¢×•×ª ×ª×•×××•×ª.
        </div>
    </div>
</div>

<script>
    const RATE = 70; const TRAVEL = 16;
    const MONTHS = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
    const DAYS = ["×","×‘","×’","×“","×”","×•","×©"];
    const DEFAULT_TEXT = `×”×™×™ ×¤×™×œ,
××¦×•×¨×£ ×“×•×— ×”×©×¢×•×ª ×©×œ×™ ×œ×—×•×“×© ×–×”.
×œ××—×¨ ×‘×“×™×§×” ×©×œ×™ ××•×œ ×”×“×•×— ×©×§×™×‘×œ×ª×™ ×××¢×¨×›×ª ××§×× ×• ×—×©×•×‘ ×œ×™ ×œ×•××¨ ×©×œ×¤×¢××™× ×™×© ×ª×§×œ×•×ª ×‘××¢×¨×›×ª ×•×–×” ××¨××” ×œ×™ ×©×–×” ×¢×•×©×” ×›× ×™×¡×” ×•×œ× ×¢×•×©×” ××• ××¨××© ×œ× ×¢×•×©×” ×‘×›×œ×œ.

×¡×”"×› ×©×¢×•×ª ×œ×ª×©×œ×•×: [×©×¢×•×ª]
×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ × ×¡×™×¢×•×ª): [×©×›×¨]

×ª×•×“×”, ××ª×Ÿ`;

    let tableData = [];
    let currentFreeText = "";

    window.onload = () => { initSelectors(); handleDateChange(); };

    function initSelectors() {
        const mSelect = document.getElementById('monthSelect');
        MONTHS.forEach((m,i) => mSelect.add(new Option(m, i)));
        const ySelect = document.getElementById('yearSelect');
        for(let y=2024; y<=2030; y++) ySelect.add(new Option(y, y));
        const now = new Date(); mSelect.value = now.getMonth(); ySelect.value = now.getFullYear();
    }

    function handleDateChange() {
        const m = document.getElementById('monthSelect').value;
        const y = document.getElementById('yearSelect').value;
        const key = `hours_v14_${y}_${m}`;
        const stored = localStorage.getItem(key);
        if(stored) {
            const parsed = JSON.parse(stored);
            tableData = parsed.data || [];
            currentFreeText = parsed.text || DEFAULT_TEXT;
            document.getElementById('customEmailText').value = currentFreeText;
            renderTable();
        } else {
            generateNewMonth();
        }
    }

    function generateNewMonth() {
        const m = parseInt(document.getElementById('monthSelect').value);
        const y = parseInt(document.getElementById('yearSelect').value);
        const daysInMonth = new Date(y, m+1, 0).getDate();
        tableData = [];
        currentFreeText = DEFAULT_TEXT;
        document.getElementById('customEmailText').value = currentFreeText;
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(y, m, i);
            const day = d.getDay();
            const isWknd = (day===5 || day===6);
            tableData.push({
                dateStr: `${i}/${m+1}`, dayName: DAYS[day], dayType: day, isWeekend: isWknd,
                event: isWknd?'×—×•×¤×©':'', hasTravel: !isWknd,
                pIn:'', pOut:'', pCalc:0, mIn:'', mOut:'', mCalc:0, notes:'', approved:false
            });
        }
        renderTable(); saveData();
    }

    function calculateRow(r) {
        const calc = (i,o) => {
            if(!i||!o) return 0;
            let d = (new Date(`2000-01-01T${o}`) - new Date(`2000-01-01T${i}`));
            if(d<0) d+=86400000;
            return Number((d/3600000).toFixed(2));
        };
        r.pCalc = calc(r.pIn, r.pOut); r.mCalc = calc(r.mIn, r.mOut);
    }
    
    function getLateness(r) {
        if(!r.mIn) return 0;
        let l=""; if(r.dayType===0) l="12:45"; else if(r.dayType>=1 && r.dayType<=4) l="13:30"; else return 0;
        const a=new Date(`2000-01-01T${r.mIn}`), t=new Date(`2000-01-01T${l}`);
        return (a-t)>0 ? Math.floor((a-t)/60000) : 0;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const showWknd = document.getElementById('toggleWeekend').checked;
        const showVac = document.getElementById('toggleVacation').checked;
        const doTravel = document.getElementById('toggleTravel').checked;
        let tP=0, tM=0, tLate=0, tTrv=0;

        tableData.forEach((r, i) => {
            calculateRow(r);
            if(!showWknd && r.isWeekend) return;
            if(!showVac && r.event==='×—×•×¤×©') return;

            tP+=r.pCalc; tM+=r.mCalc; tLate+=getLateness(r);
            const diff = r.pCalc - r.mCalc;
            if(r.mCalc>0 && r.hasTravel) tTrv++;

            const tr = document.createElement('tr');
            if(r.approved) tr.className='row-approved'; else if(r.isWeekend) tr.className='row-weekend';
            else if(r.event) tr.className='row-event'; else if(Math.abs(diff)>0.05) tr.className='row-missing';

            tr.innerHTML = `
                <td>${r.dateStr}</td><td>${r.dayName}</td>
                <td><select onchange="upd(${i},'event',this.value)" style="width:100%"><option value="" ${r.event===''?'selected':''}>-</option><option value="×—×•×¤×©" ${r.event==='×—×•×¤×©'?'selected':''}>×—×•×¤×©</option><option value="××—×œ×”" ${r.event==='××—×œ×”'?'selected':''}>××—×œ×”</option><option value="×—×’" ${r.event==='×—×’'?'selected':''}>×—×’</option><option value="×§×™×™×˜× ×”" ${r.event==='×§×™×™×˜× ×”'?'selected':''}>×§×™×™×˜× ×”</option></select></td>
                <td><div class="checkbox-wrapper"><input type="checkbox" ${r.hasTravel?'checked':''} onchange="upd(${i},'hasTravel',this.checked)"></div></td>
                <td><input type="time" value="${r.pIn}" onchange="upd(${i},'pIn',this.value)"></td><td><input type="time" value="${r.pOut}" onchange="upd(${i},'pOut',this.value)"></td><td><strong>${r.pCalc.toFixed(2)}</strong></td>
                <td><input type="time" value="${r.mIn}" onchange="upd(${i},'mIn',this.value)"></td><td><input type="time" value="${r.mOut}" onchange="upd(${i},'mOut',this.value)"></td><td><strong>${r.mCalc.toFixed(2)}</strong></td>
                <td>${getLateness(r)>0?`<span style="color:red;font-weight:bold">${getLateness(r)}</span>`:'-'}</td>
                <td style="color:${Math.abs(diff)<0.05?'green':'red'}; direction:ltr; font-weight:bold">${diff.toFixed(2)}</td>
                <td><input type="text" value="${r.notes}" onchange="upd(${i},'notes',this.value)"></td>
                <td><div class="checkbox-wrapper"><input type="checkbox" ${r.approved?'checked':''} onchange="upd(${i},'approved',this.checked)"></div></td>
            `;
            tbody.appendChild(tr);
        });

        const travelAmount = doTravel ? (tTrv * TRAVEL) : 0;
        const sal = (tM * RATE) + travelAmount;
        
        document.getElementById('sumPhil').innerText = tP.toFixed(2);
        document.getElementById('sumMatan').innerText = tM.toFixed(2);
        document.getElementById('sumDiff').innerText = (tP - tM).toFixed(2);
        document.getElementById('sumLate').innerText = tLate;
        document.getElementById('sumSalary').innerText = 'â‚ª' + sal.toLocaleString();
        document.getElementById('travelBreakdown').innerText = `×›×•×œ×œ × ×¡×™×¢×•×ª: â‚ª${travelAmount}`;
        
        const screenDiffBody = document.getElementById('screenDiffBody');
        screenDiffBody.innerHTML = '';
        const diffRows = tableData.filter(r => !r.approved && Math.abs(r.pCalc - r.mCalc) > 0.05);
        if(diffRows.length === 0) {
            document.getElementById('screenNoDiffs').style.display = 'block';
            document.getElementById('screenDiffTable').style.display = 'none';
        } else {
            document.getElementById('screenNoDiffs').style.display = 'none';
            document.getElementById('screenDiffTable').style.display = 'table';
            diffRows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.dateStr}</td><td>${r.pCalc.toFixed(2)}</td><td><strong>${r.mCalc.toFixed(2)}</strong></td><td style="color:red;direction:ltr">${(r.pCalc-r.mCalc).toFixed(2)}</td><td>${r.notes}</td>`;
                screenDiffBody.appendChild(tr);
            });
        }
    }

    function upd(i, f, v) { tableData[i][f] = v; renderTable(); saveData(); }
    
    function saveData() {
        const m = document.getElementById('monthSelect').value;
        const y = document.getElementById('yearSelect').value;
        currentFreeText = document.getElementById('customEmailText').value;
        localStorage.setItem(`hours_v14_${y}_${m}`, JSON.stringify({ data: tableData, text: currentFreeText }));
    }

    function generatePrintView() {
        const pBody = document.querySelector('#printTableBody tbody');
        const diffBody = document.getElementById('diffTableBody');
        pBody.innerHTML = ''; diffBody.innerHTML = '';
        let hasDiffs = false;

        const dateTxt = `${MONTHS[document.getElementById('monthSelect').value]} ${document.getElementById('yearSelect').value}`;
        ['pDate1', 'pDate2', 'pDateLetter'].forEach(id => document.getElementById(id).innerText = dateTxt);
        
        document.getElementById('p2SumMatan').innerText = document.getElementById('sumMatan').innerText;
        document.getElementById('p2SumPhil').innerText = document.getElementById('sumPhil').innerText;
        document.getElementById('p2SumDiff').innerText = document.getElementById('sumDiff').innerText;
        document.getElementById('p2SumPay').innerText = document.getElementById('sumSalary').innerText;
        document.getElementById('p2Travel').innerText = document.getElementById('travelBreakdown').innerText;

        let letter = document.getElementById('customEmailText').value;
        letter = letter.replace('[×©×¢×•×ª]', document.getElementById('sumMatan').innerText);
        letter = letter.replace('[×©×›×¨]', document.getElementById('sumSalary').innerText);
        document.getElementById('printLetterContent').innerText = letter;

        tableData.forEach(r => {
            const diff = r.pCalc - r.mCalc;
            const tr = document.createElement('tr');
            if(r.approved) tr.className = 'p-row-approved'; else if(r.isWeekend) tr.className = 'p-row-weekend';
            
            // ×ª×¦×•×’×ª "×××•×©×¨" ××•×ª×××ª ×œ×”×“×¤×¡×” (×˜×§×¡×˜ ×‘××§×•× ×¦'×§×‘×•×§×¡)
            const approvedMark = r.approved ? '<span class="status-ok">âœ”</span>' : '';

            tr.innerHTML = `
                <td>${r.dateStr}</td><td>${r.dayName}</td><td>${r.event||r.notes}</td>
                <td>${r.pIn}</td><td>${r.pOut}</td><td>${r.pCalc>0?r.pCalc.toFixed(2):''}</td>
                <td style="font-weight:bold; border-right:2px solid #333">${r.mIn}</td>
                <td style="font-weight:bold">${r.mOut}</td>
                <td style="font-weight:bold">${r.mCalc>0?r.mCalc.toFixed(2):''}</td>
                <td style="direction:ltr" class="${Math.abs(diff)>0.05?'p-diff':''}">${diff.toFixed(2)}</td>
                <td>${approvedMark}</td>`;
            pBody.appendChild(tr);

            if(!r.approved && Math.abs(diff) > 0.05) {
                hasDiffs = true;
                const dTr = document.createElement('tr');
                dTr.innerHTML = `<td>${r.dateStr} (${r.dayName})</td><td>${r.pCalc.toFixed(2)}</td><td><strong>${r.mCalc.toFixed(2)}</strong></td><td style="color:red;direction:ltr">${diff.toFixed(2)}</td><td>${r.notes}</td>`;
                diffBody.appendChild(dTr);
            }
        });

        document.getElementById('noDiffMsg').style.display = hasDiffs ? 'none' : 'block';
        setTimeout(() => window.print(), 200);
    }

    function handleFile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:""});
                let dateCol=-1, startCol=-1, endCol=-1, headerRow=-1;
                for(let i=0; i<Math.min(rows.length, 12); i++) {
                    const r = rows[i].map(c => String(c).toLowerCase().trim());
                    if(r.some(c => c.includes('×ª××¨×™×š') || c.includes('date'))) {
                        headerRow = i;
                        r.forEach((c, idx) => {
                            if(c.includes('×ª××¨×™×š')||c.includes('date')) dateCol=idx;
                            if(c.includes('×›× ×™×¡×”')||c.includes('in')||c.includes('start')) startCol=idx;
                            if(c.includes('×™×¦×™××”')||c.includes('out')||c.includes('end')) endCol=idx;
                        }); break;
                    }
                }
                if(dateCol===-1) { dateCol=1; startCol=3; endCol=4; headerRow=1; }
                const m = parseInt(document.getElementById('monthSelect').value);
                let u=0;
                for(let i=headerRow+1; i<rows.length; i++) {
                    const r = rows[i]; if(!r[dateCol]) continue;
                    let d=-1;
                    if(typeof r[dateCol]==='number') { const dt=new Date(Math.round((r[dateCol]-25569)*86400*1000)); if(dt.getMonth()===m) d=dt.getDate(); }
                    else if(typeof r[dateCol]==='string') { const p=r[dateCol].split(/[\/\.]/); if(p.length>0) d=parseInt(p[0]); }
                    
                    if(d>0 && d<=tableData.length) {
                        const clean=(v)=>{
                            if(typeof v==='number'){ const t=Math.round(v*1440), h=Math.floor(t/60), mn=t%60; return `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`; }
                            return v?String(v).replace(/[^\d:]/g,'').substring(0,5):'';
                        };
                        const iT=clean(r[startCol]), oT=clean(r[endCol]);
                        if(iT && oT) { tableData[d-1].pIn=iT; tableData[d-1].pOut=oT; u++; }
                    }
                }
                renderTable(); saveData(); msg(`× ×˜×¢× ×• ${u} ×©×•×¨×•×ª`, 'success');
            } catch(ex) { msg('×©×’×™××” ×‘×§×•×‘×¥', 'error'); }
        };
        reader.readAsArrayBuffer(file); input.value='';
    }

    function autoFillMatan() {
        if(!confirm("×œ××œ× ××•×˜×•××˜×™×ª?")) return;
        let c=0;
        tableData.forEach(r => {
            if(!r.approved && !r.isWeekend && !r.event && !r.mIn) {
                if(r.dayType===0){r.mIn="12:45";r.mOut="16:30";c++;}
                else{r.mIn="13:30";r.mOut="16:30";c++;}
            }
        });
        renderTable(); saveData(); msg(`××•×œ××• ${c} ×™××™×`, 'success');
    }

    function saveBackup() {
        const blob = new Blob([JSON.stringify({data:tableData, text:currentFreeText})], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `backup_${document.getElementById('yearSelect').value}_${parseInt(document.getElementById('monthSelect').value)+1}.json`; a.click();
    }
    function loadBackup(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => { 
            const p = JSON.parse(e.target.result); tableData = p.data||p; currentFreeText=p.text||DEFAULT_TEXT;
            document.getElementById('customEmailText').value = currentFreeText;
            renderTable(); saveData(); msg('×’×™×‘×•×™ × ×˜×¢×Ÿ','success');
        }; r.readAsText(f); input.value='';
    }
    function clearData() { if(confirm("×œ××—×•×§?")) { generateNewMonth(); msg('× ×•×§×”','success'); } }
    function sendWhatsapp() { const t = `×”×™×™ ×¤×™×œ, ×“×•×— ×©×¢×•×ª ${MONTHS[document.getElementById('monthSelect').value]}. ×¡×”"×›: ${document.getElementById('sumSalary').innerText}.`; window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank'); }
    function exportToExcel() { const ws = XLSX.utils.json_to_sheet(tableData.map(r=>({"×ª××¨×™×š":r.dateStr,"×™×•×":r.dayName,"×›× ×™×¡×” ×¤×™×œ":r.pIn,"×™×¦×™××” ×¤×™×œ":r.pOut,"×©×¢×•×ª ×¤×™×œ":r.pCalc,"×›× ×™×¡×” ××ª×Ÿ":r.mIn,"×™×¦×™××” ××ª×Ÿ":r.mOut,"×©×¢×•×ª ××ª×Ÿ":r.mCalc,"×”×¢×¨×•×ª":r.notes}))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Hours"); XLSX.writeFile(wb, "Hours_Report.xlsx"); }
    function msg(t, type) { const el=document.getElementById('message-area'); el.innerText=t; el.className=type==='success'?'msg-success':'msg-error'; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); }
</script>
</body>
</html>